###########
#
# Preparation:
# 1, generate make_config.mk && util/build_version.cc 
#      make util/build_version.cc
# 2, fix snappy include in util/compression.h
#      #include <snappy/snappy.h>
# 3, fix include headers
#      sh typhoon-blade/fix-include-path.sh .
# 4, fix BUILD according to Makefile && make_config.mk && src.mk
#
# Need-To-Do:
# 1, enable lz4 in util/compression.h
# 2, deal with NDEBUG macro
#
###########

common_defs = [
    'ROCKSDB_PLATFORM_POSIX',
    'OS_LINUX',
    'ROCKSDB_FALLOCATE_PRESENT',
    'SNAPPY',
    'ZLIB',
    'BZIP2',
    'NDEBUG',
]

cc_library(
    name = 'rocksdb',
    srcs = [
        'db/builder.cc',
        'db/c.cc',
        'db/column_family.cc',
        'db/compaction.cc',
        'db/compaction_job.cc',
        'db/compaction_picker.cc',
        'db/db_filesnapshot.cc',
        'db/dbformat.cc',
        'db/db_impl.cc',
        'db/db_impl_debug.cc',
        'db/db_impl_readonly.cc',
        'db/db_iter.cc',
        'db/file_indexer.cc',
        'db/filename.cc',
        'db/flush_job.cc',
        'db/flush_scheduler.cc',
        'db/forward_iterator.cc',
        'db/internal_stats.cc',
        'db/log_reader.cc',
        'db/log_writer.cc',
        'db/managed_iterator.cc',
        'db/memtable_allocator.cc',
        'db/memtable.cc',
        'db/memtable_list.cc',
        'db/merge_helper.cc',
        'db/merge_operator.cc',
        'db/repair.cc',
        'db/slice.cc',
        'db/table_cache.cc',
        'db/table_properties_collector.cc',
        'db/transaction_log_impl.cc',
        'db/version_builder.cc',
        'db/version_edit.cc',
        'db/version_set.cc',
        'db/wal_manager.cc',
        'db/write_batch.cc',
        'db/write_batch_base.cc',
        'db/write_controller.cc',
        'db/write_thread.cc',
        'port/stack_trace.cc',
        'port/port_posix.cc',
        'table/adaptive_table_factory.cc',
        'table/block_based_filter_block.cc',
        'table/block_based_table_builder.cc',
        'table/block_based_table_factory.cc',
        'table/block_based_table_reader.cc',
        'table/block_builder.cc',
        'table/block.cc',
        'table/block_hash_index.cc',
        'table/block_prefix_index.cc',
        'table/bloom_block.cc',
        'table/cuckoo_table_builder.cc',
        'table/cuckoo_table_factory.cc',
        'table/cuckoo_table_reader.cc',
        'table/flush_block_policy.cc',
        'table/format.cc',
        'table/full_filter_block.cc',
        'table/get_context.cc',
        'table/iterator.cc',
        'table/merger.cc',
        'table/meta_blocks.cc',
        'table/plain_table_builder.cc',
        'table/plain_table_factory.cc',
        'table/plain_table_index.cc',
        'table/plain_table_key_coding.cc',
        'table/plain_table_reader.cc',
        'table/table_properties.cc',
        'table/two_level_iterator.cc',
        'util/arena.cc',
        'util/auto_roll_logger.cc',
        'util/bloom.cc',
        'util/build_version.cc',
        'util/cache.cc',
        'util/coding.cc',
        'util/comparator.cc',
        'util/crc32c.cc',
        'util/db_info_dumper.cc',
        'util/dynamic_bloom.cc',
        'util/env.cc',
        'util/env_hdfs.cc',
        'util/env_posix.cc',
        'util/file_util.cc',
        'util/filter_policy.cc',
        'util/hash.cc',
        'util/hash_cuckoo_rep.cc',
        'util/hash_linklist_rep.cc',
        'util/hash_skiplist_rep.cc',
        'util/histogram.cc',
        'util/instrumented_mutex.cc',
        'util/iostats_context.cc',
        'utilities/backupable/backupable_db.cc',
        'utilities/convenience/convenience.cc',
        'utilities/checkpoint/checkpoint.cc',
        'utilities/compacted_db/compacted_db_impl.cc',
        'utilities/document/document_db.cc',
        'utilities/document/json_document_builder.cc',
        'utilities/document/json_document.cc',
        'utilities/geodb/geodb_impl.cc',
        'utilities/leveldb_options/leveldb_options.cc',
        'utilities/merge_operators/put.cc',
        'utilities/merge_operators/string_append/stringappend2.cc',
        'utilities/merge_operators/string_append/stringappend.cc',
        'utilities/merge_operators/uint64add.cc',
        'utilities/redis/redis_lists.cc',
        'utilities/spatialdb/spatial_db.cc',
        'utilities/ttl/db_ttl_impl.cc',
        'utilities/write_batch_with_index/write_batch_with_index.cc',
        'util/event_logger.cc',
        'util/ldb_cmd.cc',
        'util/ldb_tool.cc',
        'util/log_buffer.cc',
        'util/logging.cc',
        'util/memenv.cc',
        'util/murmurhash.cc',
        'util/mutable_cf_options.cc',
        'util/options_builder.cc',
        'util/options.cc',
        'util/options_helper.cc',
        'util/perf_context.cc',
        'util/rate_limiter.cc',
        'util/skiplistrep.cc',
        'util/slice.cc',
        'util/sst_dump_tool.cc',
        'util/statistics.cc',
        'util/status.cc',
        'util/string_util.cc',
        'util/sync_point.cc',
        'util/thread_local.cc',
        'util/thread_status_impl.cc',
        'util/thread_status_updater.cc',
        'util/thread_status_updater_debug.cc',
        'util/thread_status_util.cc',
        'util/thread_status_util_debug.cc',
        'util/vectorrep.cc',
        'util/xfunc.cc',
        'util/xxhash.cc',
    ],
    defs = common_defs,
    deps = [
        '//thirdparty/snappy:snappy',
        '#pthread',
        '#rt',
        '#z',
        '#bz2',
    ],
    warning = 'no',
)

cc_library(
    name = 'test_util',
    srcs = [
        'util/testutil.cc',
    ],
    defs = common_defs,
    warning = 'no',
)

cc_binary(
    name = 'db_bench',
    srcs = [
        'db/db_bench.cc',
    ],
    defs = common_defs + [
        'GFLAGS=google',
    ],
    deps = [
        '//thirdparty/gflags:gflags',
        ':rocksdb',
        ':test_util',
    ],
    warning = 'no',
)
